<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codex</title>
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <!-- CSS for Styling -->
  <style>
    body { 
      font-family: 'Lato', sans-serif; 
      background-color: #1E3A8A; 
      color: #000; 
      margin: 0; 
      padding: 0;
    }
    h1, h2 { 
      font-family: 'Georgia', serif; 
      color: #FFD700; 
    }
    .card { 
      background-color: white; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .nav-bar { 
      background-color: #FFD700; 
      position: fixed; 
      bottom: 0; 
      width: 100%; 
      display: flex; 
      justify-content: space-around; 
      padding: 8px; 
    }
    button { 
      cursor: pointer; 
    }
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    a { 
      color: #3b82f6; 
      text-decoration: underline; 
    }
    p { 
      margin: 0 0 8px 0; 
    }
  </style>
  <!-- Firebase SDK (Compat Version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Config Variables -->
  <script src="config.js"></script>
</head>
<body>
  <div id="app" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px;">
    <!-- Pages will be rendered here -->
  </div>
  <script>
    // Initialize Firebase
    firebase.initializeApp(config.firebaseConfig);
    const auth = firebase.auth();

    // App State
    let currentUser = null;
    let currentPage = 'login';
    let submissions = [];
    let activity = [];
    let leaderboard = [];
    let users = [];

    // Backend Server URL
    const BACKEND_URL = 'http://localhost:5000';

    // Pages
    const pages = {
      login: `
        <div style="background-color: white; padding: 24px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h1 style="font-size: 24px; margin-bottom: 16px; text-align: center;">Codex</h1>
          <h2 style="font-size: 20px; margin-bottom: 16px;">Login</h2>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <input id="login-email" type="email" placeholder="Email" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <input id="login-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="handleLogin()" style="width: 100%; background-color: #3b82f6; color: white; padding: 8px; border-radius: 4px;">Log In</button>
            <p style="text-align: center; color: #FFD700; cursor: pointer;" onclick="navigate('sign-up')">Need an account? Sign Up</p>
          </div>
        </div>
      `,
      'sign-up': `
        <div style="background-color: white; padding: 24px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h1 style="font-size: 24px; margin-bottom: 16px; text-align: center;">Codex</h1>
          <h2 style="font-size: 20px; margin-bottom: 16px;">Sign Up</h2>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <input id="signup-email" type="email" placeholder="Email" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <input id="signup-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="handleSignUp()" style="width: 100%; background-color: #3b82f6; color: white; padding: 8px; border-radius: 4px;">Sign Up</button>
            <p style="text-align: center; color: #FFD700; cursor: pointer;" onclick="navigate('login')">Already have an account? Log In</p>
          </div>
        </div>
      `,
      home: `
        <div style="width: 100%; max-width: 800px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h1 style="font-size: 24px;">Codex</h1>
            <button onclick="navigate('profile')" style="background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 4px;">Profile</button>
          </div>
          <div id="submissions" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 60px;">
            <!-- Submissions will be loaded here -->
          </div>
          <div class="nav-bar">
            <button onclick="navigate('home')" style="color: #3b82f6;">Home</button>
            <button onclick="navigate('submit')" style="color: #3b82f6;">Submit</button>
            <button onclick="navigate('leaderboard')" style="color: #3b82f6;">Leaderboard</button>
          </div>
        </div>
      `,
      submit: `
        <div style="background-color: white; padding: 24px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h1 style="font-size: 24px; margin-bottom: 16px;">Submit Media</h1>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <input id="submit-url" type="text" placeholder="URL" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <select id="submit-priority" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="1">1 (Most Important)</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5 (Least Important)</option>
            </select>
            <button onclick="handleSubmit()" style="width: 100%; background-color: #3b82f6; color: white; padding: 8px; border-radius: 4px;">Submit</button>
            <button onclick="navigate('home')" style="width: 100%; background-color: #6b7280; color: white; padding: 8px; border-radius: 4px;">Back to Home</button>
          </div>
        </div>
      `,
      profile: `
        <div style="background-color: white; padding: 24px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h1 style="font-size: 24px; margin-bottom: 16px;">Profile</h1>
          <p id="profile-email" style="margin-bottom: 8px;">Email: </p>
          <p id="profile-points" style="margin-bottom: 8px;">Points: </p>
          <p id="profile-title" style="margin-bottom: 16px;">Title: </p>
          <button onclick="handleLogout()" style="width: 100%; background-color: #ef4444; color: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">Logout</button>
          <button onclick="navigate('home')" style="width: 100%; background-color: #6b7280; color: white; padding: 8px; border-radius: 4px;">Back to Home</button>
        </div>
      `,
      leaderboard: `
        <div style="background-color: white; padding: 24px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h1 style="font-size: 24px; margin-bottom: 16px;">Leaderboard</h1>
          <div id="leaderboard-list" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Leaderboard will be loaded here -->
          </div>
          <button onclick="navigate('home')" style="width: 100%; background-color: #6b7280; color: white; padding: 8px; border-radius: 4px; margin-top: 16px;">Back to Home</button>
        </div>
      `
    };

    // Navigation Function
    function navigate(page) {
      currentPage = page;
      renderPage();
    }

    // Render Page
    function renderPage() {
      const app = document.getElementById('app');
      app.innerHTML = pages[currentPage];
      if (currentPage === 'profile' && currentUser) {
        document.getElementById('profile-email').textContent = `Email: ${currentUser.email}`;
        loadUserProfile();
      }
      if (currentPage === 'home') {
        loadSubmissions();
      }
      if (currentPage === 'leaderboard') {
        loadLeaderboard();
      }
    }

    // Authentication Handlers
    function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          navigate('home');
        })
        .catch(error => alert(error.message));
    }

    function handleSignUp() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          addUserToSheet(email);
          navigate('home');
        })
        .catch(error => alert(error.message));
    }

    function handleLogout() {
      auth.signOut().then(() => {
        currentUser = null;
        navigate('login');
      });
    }

    // Backend API Functions
    async function addUserToSheet(email) {
      try {
        const response = await fetch(`${BACKEND_URL}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            points: 0,
            title: ''
          })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error('Failed to add user to sheet');
      } catch (error) {
        console.error('Error adding user:', error);
      }
    }

    async function handleSubmit() {
      if (!currentUser) return;
      const url = document.getElementById('submit-url').value;
      const priority = parseInt(document.getElementById('submit-priority').value);
      const timestamp = new Date().toISOString();
      try {
        const response = await fetch(`${BACKEND_URL}/submissions`);
        const data = await response.json();
        console.log('Fetched Submissions Data:', data);
        const nextId = data.submissions ? data.submissions.length + 1 : 1;
        const appendResponse = await fetch(`${BACKEND_URL}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: nextId,
            url: url,
            priority: priority,
            submitterEmail: currentUser.email,
            timestamp: timestamp
          })
        });
        const appendResult = await appendResponse.json();
        console.log('Append Response:', appendResult);
        if (appendResult.status !== 'success') {
          throw new Error(`Failed to submit media: ${appendResult.message}`);
        }
        loadSubmissions();
        navigate('home');
      } catch (error) {
        console.error('Error submitting media:', error);
        alert('Failed to submit media: ' + error.message);
      }
    }

    async function loadSubmissions() {
      try {
        const response = await fetch(`${BACKEND_URL}/submissions`);
        const data = await response.json();
        submissions = data.submissions || [];
        submissions.sort((a, b) => a.priority - b.priority);
        const submissionsDiv = document.getElementById('submissions');
        submissionsDiv.innerHTML = submissions.map(submission => `
          <div style="background-color: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <a href="${submission.url}" target="_blank" onclick="handleClick(${submission.id}); return false;">${submission.url}</a>
            <p>Priority: ${submission.priority}</p>
            <p>Submitted by: ${submission.submitterEmail}</p>
            <p>Status: ${getStatus(submission.id)}</p>
            <button onclick="markCompleted(${submission.id})" style="background-color: #10b981; color: white; padding: 8px 16px; border-radius: 4px; ${getStatus(submission.id) === 'completed' ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${getStatus(submission.id) === 'completed' ? 'disabled' : ''}>Mark Completed</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading submissions:', error);
      }
    }

    function getStatus(submissionId) {
      const userActivity = activity.find(a => a.userEmail === currentUser.email && a.submissionId === submissionId);
      return userActivity ? userActivity.status : 'unclicked';
    }

    async function handleClick(submissionId) {
      if (!currentUser) return;
      const userActivity = activity.find(a => a.userEmail === currentUser.email && a.submissionId === submissionId);
      if (userActivity && userActivity.status === 'completed') return;
      const newStatus = userActivity && userActivity.status === 'clicked' ? 'unclicked' : 'clicked';
      try {
        const response = await fetch(`${BACKEND_URL}/activity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userEmail: currentUser.email,
            submissionId: submissionId,
            status: newStatus,
            timestamp: new Date().toISOString(),
            month: new Date().toISOString().slice(0, 7)
          })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error('Failed to update activity');
        await loadActivity();
        loadSubmissions();
      } catch (error) {
        console.error('Error updating activity:', error);
      }
    }

    async function markCompleted(submissionId) {
      if (!currentUser) return;
      const userActivity = activity.find(a => a.userEmail === currentUser.email && a.submissionId === submissionId);
      if (userActivity && userActivity.status === 'completed') return;
      const submission = submissions.find(s => s.id === submissionId);
      const points = 6 - submission.priority;
      const currentMonth = new Date().toISOString().slice(0, 7);
      try {
        // Update Activity
        await fetch(`${BACKEND_URL}/activity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userEmail: currentUser.email,
            submissionId: submissionId,
            status: 'completed',
            timestamp: new Date().toISOString(),
            month: currentMonth
          })
        });
        // Update User Points
        const userResponse = await fetch(`${BACKEND_URL}/users`);
        const userData = await userResponse.json();
        let userPoints = 0;
        let user = userData.users.find(u => u.email === currentUser.email);
        if (user) {
          userPoints = user.points + points;
        } else {
          userPoints = points;
        }
        await fetch(`${BACKEND_URL}/users/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUser.email,
            points: userPoints
          })
        });
        // Update Leaderboard
        const leaderboardResponse = await fetch(`${BACKEND_URL}/leaderboard`);
        const leaderboardData = await leaderboardResponse.json();
        let currentLeaderboardPoints = 0;
        let leaderboardEntry = leaderboardData.leaderboard.find(entry => entry.userEmail === currentUser.email && entry.month === currentMonth);
        if (leaderboardEntry) {
          currentLeaderboardPoints = leaderboardEntry.points + points;
        } else {
          currentLeaderboardPoints = points;
        }
        if (!leaderboardEntry) {
          await fetch(`${BACKEND_URL}/leaderboard`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userEmail: currentUser.email,
              month: currentMonth,
              points: currentLeaderboardPoints,
              title: ''
            })
          });
        } else {
          await fetch(`${BACKEND_URL}/leaderboard/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userEmail: currentUser.email,
              month: currentMonth,
              points: currentLeaderboardPoints
            })
          });
        }
        await updateLeaderboard();
        await loadActivity();
        loadSubmissions();
      } catch (error) {
        console.error('Error marking completed:', error);
      }
    }

    async function loadActivity() {
      try {
        const response = await fetch(`${BACKEND_URL}/activity`);
        const data = await response.json();
        activity = data.activity || [];
        if (currentPage === 'home') loadSubmissions();
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }

    async function loadUserProfile() {
      try {
        const response = await fetch(`${BACKEND_URL}/users`);
        const data = await response.json();
        users = data.users || [];
        const user = users.find(u => u.email === currentUser.email);
        if (user) {
          document.getElementById('profile-points').textContent = `Points: ${user.points}`;
          document.getElementById('profile-title').textContent = `Title: ${user.title || 'None'}`;
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
      }
    }

    async function updateLeaderboard() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      try {
        const response = await fetch(`${BACKEND_URL}/leaderboard`);
        const data = await response.json();
        leaderboard = data.leaderboard || [];
        const currentLeaderboard = leaderboard.filter(entry => entry.month === currentMonth);
        currentLeaderboard.sort((a, b) => b.points - a.points);
        if (currentLeaderboard.length > 0) {
          const topUser = currentLeaderboard[0];
          const title = config.monthlyTitles[new Date().getMonth() % config.monthlyTitles.length];
          topUser.title = title;
          await fetch(`${BACKEND_URL}/leaderboard/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userEmail: topUser.userEmail,
              month: currentMonth,
              points: topUser.points,
              title: title
            })
          });
          const userResponse = await fetch(`${BACKEND_URL}/users`);
          const userData = await userResponse.json();
          const user = userData.users.find(u => u.email === topUser.userEmail);
          if (user) {
            await fetch(`${BACKEND_URL}/users/update`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: topUser.userEmail,
                points: user.points,
                title: title
              })
            });
          }
        }
      } catch (error) {
        console.error('Error updating leaderboard:', error);
      }
    }

    async function loadLeaderboard() {
      try {
        const response = await fetch(`${BACKEND_URL}/leaderboard`);
        const data = await response.json();
        leaderboard = data.leaderboard || [];
        const currentMonth = new Date().toISOString().slice(0, 7);
        const currentLeaderboard = leaderboard.filter(entry => entry.month === currentMonth);
        currentLeaderboard.sort((a, b) => b.points - a.points);
        const leaderboardDiv = document.getElementById('leaderboard-list');
        leaderboardDiv.innerHTML = currentLeaderboard.map(entry => `
          <div style="padding: 8px; border-bottom: 1px solid #ccc;">
            <p>User: ${entry.userEmail}</p>
            <p>Points: ${entry.points}</p>
            ${entry.title ? `<p>Title: ${entry.title}</p>` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Initial Render
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        navigate('home');
      } else {
        navigate('login');
      }
    });
    renderPage();
  </script>
</body>
</html>